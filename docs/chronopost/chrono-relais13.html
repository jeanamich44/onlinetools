<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Chrono Relais 13 - Générer Bordereau</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Specific Styles for Chrono Relais Layout */
        .relais-dest-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .pickup-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .pickup-btn {
            background-color: #0099ff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 15px;
            display: block;
            text-align: center;
            text-decoration: none;
        }

        .pickup-btn:hover {
            background-color: #0077cc;
        }

        .pickup-code-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .pickup-code-row label {
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .pickup-code-row input {
            width: 80px;
            padding: 5px;
        }

        .pickup-code-row button {
            background-color: #0099ff;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .colis-dimensions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .dim-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .dim-cube {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #555;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            font-size: 0.8rem;
            color: #aaa;
        }

        @media (max-width: 768px) {

            .relais-dest-grid,
            .colis-dimensions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div id="overlay" style="flex-direction: column; gap: 20px;">
        <div class="spinner"></div>
        <div id="timerContainer" style="display:none; text-align: center; color: #fff;">
            <span style="font-size: 1.2rem; font-weight: bold;" id="timer">00:00</span>
            <span class="info-icon" style="margin-left: 10px; vertical-align: middle;"
                data-tooltip="La génération peut prendre jusqu'à 4min, il est obligatoire de rester sur la page. Le bordereau sera envoyé sur le mail de réception, donc regardez la boîte de réception. Si après 4min vous n'avez pas de mail, regardez les spams. Si toujours pas, contactez le gérant : https://t.me/RheyyFonda">i</span>
        </div>
    </div>

    <!-- Weight Limit Modal -->
    <div id="weightModal" class="modal-overlay" style="display:none;">
        <div class="modal-box blue-theme">
            <h3>Attention - Poids Excéde 20kg</h3>
            <p>Pour tout envoi supérieur à 20kg, veuillez contacter le gérant.</p>
            <a href="https://t.me/RheyyFonda" target="_blank" class="contact-btn">Contacter Support (Telegram)</a>
            <button onclick="closeWeightModal()" class="close-btn">Fermer</button>
        </div>
    </div>

    <div id="statusMessage" style="position:fixed; top:80px; width:100%; text-align:center; z-index:900;"></div>

    <header class="header">
        <div class="header-inner">
            <a href="../index.html" class="logo">OnlineTools</a>
            <nav class="nav">
                <a href="../index.html">Home</a>
                <a href="../tools/tools-liste.html">Tools</a>
                <a href="../contact.html">Contact</a>

            </nav>
        </div>
    </header>

    <main class="content form-container">

        <h1 class="page-title">Chrono Relais 13 - Livraison en Relais avant 13h</h1>

        <form id="chronoForm" onsubmit="handleSubmit(event)">
            <input type="hidden" name="valeurproduct" value="relais">

            <div class="sections-grid">
                <!-- Section 2: Expéditeur (copied from chrono13) -->
                <div class="form-section">
                    <div class="section-header">
                        <span>
                            <span class="section-number">1</span> Expéditeur
                            <span class="info-icon"
                                data-tooltip="Si laissés vides, des coordonnées aléatoires uniques seront utilisées pour garantir un meilleur anonymat et une intraçabilité. Remplissez les cases que vous souhaitez, les autres seront générées. Seules les cases avec * sont obligatoires. Cela concerne uniquement la catégorie expéditeur.">i</span>
                        </span>
                        <span>FRANCE</span>
                    </div>
                    <div class="section-content">
                        <div class="radio-group" style="margin-bottom: 20px;">
                            <label>Type *</label>
                            <label><input type="radio" name="senderType" value="0"> Professionnel</label>
                            <label><input type="radio" name="senderType" value="1" checked> Particulier</label>
                        </div>

                        <div class="form-row">
                            <div class="form-group" id="senderCompanyDiv" style="display:none;">
                                <label>Nom de société</label>
                                <input type="text" name="senderCompanyName">
                            </div>
                            <input type="hidden" name="senderCountry" value="FR">
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" name="senderLastname" placeholder="Vide = Aléatoire">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Prénom</label>
                                <input type="text" name="senderFirstname" placeholder="Vide = Aléatoire">
                            </div>
                            <div class="form-group">
                                <label>Code Postal</label>
                                <input type="text" name="senderCP" pattern="\d+" placeholder="Vide = Aléatoire">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Téléphone</label>
                                <input type="tel" name="senderHandphone" minlength="8" placeholder="Vide = Aléatoire"
                                    maxlength="14">
                            </div>
                            <div class="form-group">
                                <label>Ville</label>
                                <input type="text" name="senderCity" placeholder="Vide = Aléatoire">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>E-mail</label>
                                <input type="email" name="senderEmail" placeholder="Vide = Aléatoire" maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Adresse</label>
                                <input type="text" name="senderAddress" placeholder="Vide = Aléatoire">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Complément adresse</label>
                                <input type="text" name="senderAddress2" maxlength="20">
                            </div>
                            <div class="form-group">
                                <label>Référence Expéditeur</label>
                                <input type="text" name="senderRef" maxlength="14">
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <label><input type="checkbox" name="exp_save"> Conserver cet expéditeur</label>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Destinataire (CUSTOMIZED FOR RELAIS) -->
                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">2</span> Destinataire</span>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span>Pickup</span>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="relais-dest-grid">
                            <!-- Left Column -->
                            <div class="left-col">
                                <div class="form-group">
                                    <label>Nom *</label>
                                    <input type="text" name="receiverLastname" required>
                                </div>
                                <div class="form-group">
                                    <label>Prénom *</label>
                                    <input type="text" name="receiverFirstname" required>
                                </div>
                                <div class="form-group">
                                    <label>Téléphone (mobile de préférence) *</label>
                                    <input type="tel" name="receiverHandphone" minlength="8" required maxlength="14">
                                </div>
                                <div class="form-group">
                                    <label>E-mail *</label>
                                    <input type="email" name="receiverEmail" required maxlength="60">
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="right-col">
                                <!-- Old position of address fields removed -->

                                <div class="pickup-section">
                                    <a href="https://www.chronopost.fr/expeditionAvanceeSec/ounoustrouver.html"
                                        target="_blank" class="pickup-btn">Trouver votre relais Pickup</a>

                                    <div class="pickup-code-row">
                                        <label>Je connais le code de mon relais pickup :</label>
                                    </div>
                                    <div class="pickup-code-row">
                                        <label>Relais pickup</label>
                                        <input type="text" name="codeRelais" id="codeRelaisInput" placeholder="">
                                        <button type="button" id="btnCheckRelais">OK</button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Nom point relais</label>
                                    <input type="text" name="relaisName" id="relaisName" required readonly
                                        style="background-color: #2a2f3a; color: #888; border-color: #444; cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label>Code Postal</label>
                                    <input type="text" name="receiverCP" id="relaisCP" required pattern="\d+" readonly
                                        style="background-color: #2a2f3a; color: #888; border-color: #444; cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label>Ville</label>
                                    <input type="text" name="receiverCity" id="relaisCity" required readonly
                                        style="background-color: #2a2f3a; color: #888; border-color: #444; cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label>Adresse</label>
                                    <input type="text" name="receiverAddress" id="relaisAddress" required readonly
                                        style="background-color: #2a2f3a; color: #888; border-color: #444; cursor: not-allowed;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checkbox-group" style="margin-top: 20px;">
                        <label><input type="checkbox" name="dest_save"> Conserver ce destinataire</label>
                    </div>
                </div>
            </div>
            </div>

            <div class="sections-grid">
                <!-- Section 4: Colis (CUSTOMIZED FOR RELAIS) -->
                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">3</span> Colis</span>
                    </div>
                    <div class="section-content">
                        <div class="colis-dimensions-grid">
                            <div class="dim-inputs">
                                <div class="form-row">
                                    <!-- Removed Number of Packages field -->
                                    <div class="form-group">
                                        <label>Poids unitaire (kg) *</label>
                                        <input type="number" name="packageWeight" id="weightInput" required step="0.1">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Nom de l'envoi</label>
                                    <input type="text" name="shippingRef" maxlength="15">
                                </div>
                                <div class="form-group">
                                    <label>Date de l'envoi</label>
                                    <input type="date" name="shippingDate_input">
                                </div>

                                <div class="form-group">
                                    <label>Longueur (cm) *</label>
                                    <input type="number" name="packageLength" required min="1" max="100">
                                </div>
                                <div class="form-group">
                                    <label>Largeur (cm) *</label>
                                    <input type="number" name="packageWidth" required min="17" max="100">
                                </div>
                                <div class="form-group">
                                    <label>Hauteur (cm) *</label>
                                    <input type="number" name="packageHeight" required min="1" max="100">
                                </div>
                            </div>

                            <div class="dim-info">
                                <div class="dim-cube" style="font-size: 0.85rem;">
                                    <div>
                                        <strong>Dimensions maximales :</strong><br>
                                        (Longueur + 2xHauteur + 2xLargeur) = 250 cm<br>
                                        Longueur= 100 cm, Largeur= 100 cm, Hauteur= 100 cm<br>
                                        <br>
                                        <strong>MAX 20 Kg</strong>
                                    </div>
                                </div>
                                <div class="dim-cube" style="margin-top: 10px; font-size: 0.85rem;">
                                    <div>
                                        <strong>Dimensions minimales :</strong><br>
                                        Longueur= 1 cm, Largeur= 17 cm, Hauteur= 1 cm<br>
                                        <br>
                                        <strong>MIN 1 g</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <label><input type="checkbox" name="colis_save"> Conserver ces caractéristiques</label>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Options -->
                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">4</span> Options & Notifications</span>
                    </div>
                    <div class="section-content">
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="shipmentTracking_box" checked> Suivi mail
                                expéditeur</label>
                            <input type="hidden" name="shipmentTracking" value="on">
                        </div>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="notifyTheReceiver_box" checked> Suivi mail
                                destinataire</label>
                            <input type="hidden" name="notifyTheReceiver" value="on">
                        </div>


                        <div class="form-group" style="margin-top: 15px;">
                            <label>Mail Tiers (Réception Bordereau) * <span class="info-icon"
                                    data-tooltip="Insérez le mail sur lequel recevoir le bordereau. Ce mail est uniquement utilisé pour la réception du bordereau. Pour avoir un suivi par mail, il faut saisir un mail dans la catégorie voulue (Expéditeur ou Destinataire).">i</span></label>
                            <input type="email" name="sendToThirdPersonInfo" required
                                placeholder="Votre email pour recevoir le PDF">
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button type="submit" class="btn-validate" id="btn-validate">Valider et imprimer Label / Bordereau de
                    Livraison </button>
            </div>



        </form>
        <a class="back" href="./chronopost-liste.html">Retour</a>
    </main>
    <script src="../js/chronopost-autocomplete.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Handle checkbox to hidden input sync
            document.querySelectorAll('input[type="checkbox"]').forEach(box => {
                box.addEventListener('change', e => {
                    const hidden = e.target.parentElement.nextElementSibling;
                    if (hidden && hidden.type === 'hidden') {
                        hidden.value = e.target.checked ? 'on' : 'off';
                    }
                });
            });

            // Helper to toggle company field visibility
            function setupVisibilityToggle(radioName, divId) {
                const radios = document.getElementsByName(radioName);
                const targetDiv = document.getElementById(divId);

                if (!targetDiv) return;

                function update() {
                    const checked = document.querySelector(`input[name="${radioName}"]:checked`);
                    if (checked) {
                        if (checked.value === "0") {
                            targetDiv.style.display = "block";
                        } else {
                            targetDiv.style.display = "none";
                        }
                    }
                }
                radios.forEach(r => r.addEventListener('change', update));
                update();
            }

            setupVisibilityToggle('senderType', 'senderCompanyDiv');

            const weightInput = document.getElementById('weightInput');
            if (weightInput) {
                weightInput.addEventListener('change', function () {
                    if (parseFloat(this.value) > 20) {
                        document.getElementById('weightModal').style.display = 'flex';
                        this.value = 20;
                    }
                });
            }

            // --- RELAY LOOKUP LOGIC ---
            const btnCheckRelais = document.getElementById('btnCheckRelais');
            const codeRelaisInput = document.getElementById('codeRelaisInput');

            if (btnCheckRelais && codeRelaisInput) {
                btnCheckRelais.addEventListener('click', async () => {
                    const code = codeRelaisInput.value.trim();
                    if (!code) {
                        alert("Veuillez entrer un code relais.");
                        return;
                    }

                    btnCheckRelais.disabled = true;
                    btnCheckRelais.textContent = "...";

                    try {
                        const resp = await fetch('https://chronopost.up.railway.app/generate-chronopost/get-relay-info', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ pickup_id: code })
                        });

                        const res = await resp.json();

                        if (res.status === 'success') {
                            document.getElementById('relaisName').value = res.nom || "";
                            document.getElementById('relaisCP').value = res.cp || "";
                            document.getElementById('relaisCity').value = res.ville || "";
                            document.getElementById('relaisAddress').value = res.adresse || "";
                        } else {
                            alert("Erreur : " + (res.message || "Impossible de récupérer les infos relais."));
                        }

                    } catch (e) {
                        alert("Erreur réseau : " + e.message);
                    } finally {
                        btnCheckRelais.disabled = false;
                        btnCheckRelais.textContent = "OK";
                    }
                });
            }
        });

        function closeWeightModal() {
            document.getElementById('weightModal').style.display = 'none';
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            if (data.shippingDate_input) {
                const parts = data.shippingDate_input.split('-');
                if (parts.length === 3) {
                    const [y, m, d] = parts;
                    data.shippingDate = `${d}/${m}/${y}`;
                }
            }
            delete data.shippingDate_input;

            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = '';
            statusDiv.className = '';

            const overlay = document.getElementById('overlay');
            if (overlay) overlay.style.visibility = 'visible';

            const btn = document.getElementById('btn-validate');
            const timerContainer = document.getElementById('timerContainer');
            const timerSpan = document.getElementById('timer');

            btn.disabled = true;
            btn.textContent = "Génération en cours...";

            timerContainer.style.display = 'block';
            let seconds = 0;
            timerSpan.textContent = "00:00";

            let timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                timerSpan.textContent = `${m}:${s}`;
            }, 1000);

            try {
                const response = await fetch('https://chronopost.up.railway.app/generate-chronopost/generate-chronopost', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data })
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    statusDiv.textContent = "Génération réussie ! Durée: " + (result.duration ? result.duration.toFixed(2) : "?") + "s";
                    statusDiv.className = "success-message";
                } else {
                    throw new Error(result.message || "Erreur inconnue");
                }

            } catch (error) {
                statusDiv.textContent = "Erreur: " + error.message;
                statusDiv.className = "error-message";
            } finally {
                if (overlay) overlay.style.visibility = 'hidden';
                if (timerInterval) clearInterval(timerInterval);
                if (timerContainer) timerContainer.style.display = 'none';
                btn.disabled = false;
                btn.textContent = "Valider et imprimer Label / Bordereau de Livraison";
            }
        }
    </script>
</body>

</html>