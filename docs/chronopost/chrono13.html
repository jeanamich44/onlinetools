<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Chrono 13 - Générer Bordereau</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">

</head>

<body>

    <div id="overlay" style="flex-direction: column; gap: 20px;">
        <div class="spinner"></div>
        <div id="timerContainer" style="display:none; text-align: center; color: #fff;">
            <span style="font-size: 1.2rem; font-weight: bold;" id="timer">00:00</span>
            <span class="info-icon" style="margin-left: 10px; vertical-align: middle;"
                data-tooltip="La génération peut prendre jusqu'à 4min, il est obligatoire de rester sur la page. Le bordereau sera envoyé sur le mail de réception, donc regardez la boîte de réception. Si après 4min vous n'avez pas de mail, regardez les spams. Si toujours pas, contactez le gérant : https://t.me/RheyyFonda">i</span>
        </div>
    </div>

    <!-- Weight Limit Modal -->
    <div id="weightModal" class="modal-overlay" style="display:none;">
        <div class="modal-box blue-theme">
            <h3>Attention - Poids Excéde 30kg</h3>
            <p>Pour tout envoi supérieur à 30kg, veuillez contacter le gérant.</p>
            <a href="https://t.me/RheyyFonda" target="_blank" class="contact-btn">Contacter Support (Telegram)</a>
            <button onclick="closeWeightModal()" class="close-btn">Fermer</button>
        </div>
    </div>

    <div id="statusMessage" style="position:fixed; top:80px; width:100%; text-align:center; z-index:900;"></div>

    <header class="header">
        <div class="header-inner">
            <a href="../index.html" class="logo">OnlineTools</a>
            <nav class="nav">
                <a href="../index.html">Home</a>
                <a href="../tools/tools-liste.html">Tools</a>
                <a href="../contact.html">Contact</a>

            </nav>
        </div>
    </header>

    <main class="content form-container">

        <h1 class="page-title">Chrono 13 - Livraison demain avant 13h</h1>

        <form id="chronoForm" onsubmit="handleSubmit(event)">
            <input type="hidden" name="valeurproduct" value="13">

            <div class="sections-grid">
                <!-- Section 2: Expéditeur -->
                <div class="form-section">
                    <div class="section-header">
                        <span>
                            <span class="section-number">1</span> Expéditeur
                            <span class="info-icon"
                                data-tooltip="Si laissés vides, des coordonnées aléatoires uniques seront utilisées pour garantir un meilleur anonymat et une intraçabilité. Remplissez les cases que vous souhaitez, les autres seront générées. Seules les cases avec * sont obligatoires. Cela concerne uniquement la catégorie expéditeur.">i</span>
                        </span>
                        <span>FRANCE</span>
                    </div>
                    <div class="section-content">
                        <div class="radio-group" style="margin-bottom: 20px;">
                            <label>Type *</label>
                            <label><input type="radio" name="senderType" value="0"> Professionnel</label>
                            <label><input type="radio" name="senderType" value="1" checked> Particulier</label>
                        </div>

                        <div class="form-row">
                            <div class="form-group" id="senderCompanyDiv" style="display:none;">
                                <label>Nom de société</label>
                                <input type="text" name="senderCompanyName" maxlength="60">
                            </div>
                            <input type="hidden" name="senderCountry" value="FR">
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" name="senderLastname" placeholder="Vide = Aléatoire" maxlength="60">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Prénom</label>
                                <input type="text" name="senderFirstname" placeholder="Vide = Aléatoire" maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Code Postal</label>
                                <input type="text" name="senderCP" pattern="\d+" placeholder="Vide = Aléatoire"
                                    maxlength="60">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Téléphone</label>
                                <input type="tel" name="senderHandphone" minlength="8" placeholder="Vide = Aléatoire"
                                    value="" maxlength="14">
                            </div>
                            <div class="form-group">
                                <label>Ville</label>
                                <input type="text" name="senderCity" placeholder="Vide = Aléatoire" maxlength="60">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>E-mail</label>
                                <input type="email" name="senderEmail" placeholder="Vide = Aléatoire" maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Adresse</label>
                                <input type="text" name="senderAddress" placeholder="Vide = Aléatoire" maxlength="60">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Complément adresse</label>
                                <input type="text" name="senderAddress2" maxlength="20">
                            </div>
                            <div class="form-group">
                                <label>Référence Expéditeur</label>
                                <input type="text" name="senderRef" maxlength="14">
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <label><input type="checkbox" name="exp_save"> Conserver cet expéditeur pour mes prochains
                                envois</label>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Destinataire -->
                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">2</span> Destinataire</span>
                        <span>FRANCE</span>
                    </div>
                    <div class="section-content">
                        <div class="radio-group" style="margin-bottom: 20px;">
                            <label>Type *</label>
                            <label><input type="radio" name="receiverType" value="0"> Professionnel</label>
                            <label><input type="radio" name="receiverType" value="1" checked> Particulier</label>
                        </div>

                        <div class="form-row">
                            <div class="form-group" id="receiverCompanyDiv">
                                <label>Raison Sociale *</label>
                                <input type="text" name="receiverCompanyName" maxlength="60">
                            </div>
                            <input type="hidden" name="receiverCountry" value="FR">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom *</label>
                                <input type="text" name="receiverLastname" required maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Code Postal *</label>
                                <input type="text" name="receiverCP" required pattern="\d+" maxlength="60">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Prénom *</label>
                                <input type="text" name="receiverFirstname" required maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Ville *</label>
                                <input type="text" name="receiverCity" required maxlength="60">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Téléphone *</label>
                                <input type="tel" name="receiverHandphone" minlength="8" required maxlength="14">
                            </div>
                            <div class="form-group">
                                <label>Adresse *</label>
                                <input type="text" name="receiverAddress" required maxlength="60">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>E-mail *</label>
                                <input type="email" name="receiverEmail" required maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Complément adresse</label>
                                <input type="text" name="receiverAddress2" maxlength="20">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Code Bâtiment</label>
                                <input type="text" name="receiverAddress3" maxlength="8">
                            </div>
                            <div class="form-group">
                                <label>Référence Destinataire</label>
                                <input type="text" name="receiverRef" maxlength="14">
                            </div>
                        </div>


                        <div class="checkbox-group">
                            <label><input type="checkbox" name="dest_save"> Conserver ce destinataire pour mes prochains
                                envois</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sections-grid">
                <!-- Section 4: Colis -->
                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">3</span> Colis</span>
                    </div>
                    <div class="section-content">
                        <div class="form-row">
                            <!-- Removed number of packages as payload seems to handle 1 by default structure? 
                                 payloads.py has "&NbOfPackages=1". We can keep it visual or force it. 
                                 Let's simplistic mapping packageWeight -->
                            <div class="form-group">
                                <label>Poids (kg) *</label>
                                <input type="number" name="packageWeight" id="weightInput" required step="0.1"
                                    placeholder="Ex: 5">
                            </div>
                            <div class="form-group">
                                <label>Nom de l'envoi</label>
                                <input type="text" name="shippingRef" maxlength="15">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Date de l'envoi</label>
                                <input type="date" name="shippingDate_input">
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <label><input type="checkbox" name="colis_save"> Conserver ces caractéristiques</label>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Options -->
                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">4</span> Options & Notifications</span>
                    </div>
                    <div class="section-content">
                        <!-- Insurance handled via insurancePrice in payload? Not fully implemented in payloads.py yet?
                             payloads.py has "insurancePrice=". If I pass it, it might work. 
                             Keeping simpler for now as per payloads.py mapping. -->

                        <div class="checkbox-group">
                            <label><input type="checkbox" name="shipmentTracking_box" checked> Suivi mail
                                expéditeur</label>
                            <input type="hidden" name="shipmentTracking" value="on">
                        </div>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="notifyTheReceiver_box" checked> Suivi mail
                                destinataire</label>
                            <input type="hidden" name="notifyTheReceiver" value="on">
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>Mail Tiers (Réception Bordereau) * <span class="info-icon"
                                    data-tooltip="Insérez le mail sur lequel recevoir le bordereau. Ce mail est uniquement utilisé pour la réception du bordereau. Pour avoir un suivi par mail, il faut saisir un mail dans la catégorie voulue (Expéditeur ou Destinataire).">i</span></label>
                            <input type="email" name="sendToThirdPersonInfo" required maxlength="60"
                                placeholder="Votre email pour recevoir le PDF">
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button type="submit" class="btn-validate" id="btn-validate">Générer Preview (Gratuit)</button>
            </div>

            <div id="message"></div>
            <div style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px; text-align: center;">
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Le bordereau officiel sans filigrane est payant (1€).</p>
                <button id="btnPay" type="button"
                    style="background-color: #28a745; width: 100%; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 1.1rem; font-weight: bold;">Valider et Payer le Bordereau (1€)</button>
            </div>



        </form>
        <a class="back" href="./chronopost-liste.html">Retour</a>
    </main>
    <script src="../js/chronopost-autocomplete.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check for success from payment redirect
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('success')) {
                const savedData = localStorage.getItem('chronoData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    localStorage.removeItem('chronoData');
                    // Automatically trigger the generation
                    performGeneration(data);
                }
            }

            try {
                // Handle checkbox to hidden input sync
                document.querySelectorAll('input[type="checkbox"]').forEach(box => {
                    box.addEventListener('change', e => {
                        const hidden = e.target.parentElement.nextElementSibling;
                        if (hidden && hidden.type === 'hidden') {
                            hidden.value = e.target.checked ? 'on' : 'off';
                        }
                    });
                });

                // Helper to toggle company field visibility
                function setupVisibilityToggle(radioName, divId) {
                    const radios = document.getElementsByName(radioName);
                    const targetDiv = document.getElementById(divId);

                    if (!targetDiv) {
                        console.error("Target div not found:", divId);
                        return;
                    }

                    function update() {
                        // Find the checked radio
                        const checked = document.querySelector(`input[name="${radioName}"]:checked`);
                        if (checked) {
                            // value "0" is Professionnel -> Show
                            // value "1" is Particulier -> Hide
                            if (checked.value === "0") {
                                targetDiv.style.display = "block";
                            } else {
                                targetDiv.style.display = "none";
                            }
                        }
                    }

                    // Attach listener to all radios in group
                    radios.forEach(r => r.addEventListener('change', update));

                    // Run once on load
                    update();
                }

                // Initialize Toggles
                setupVisibilityToggle('senderType', 'senderCompanyDiv');
                setupVisibilityToggle('receiverType', 'receiverCompanyDiv');

                // Weight Limit Listener
                const weightInput = document.getElementById('weightInput');
                if (weightInput) {
                    weightInput.addEventListener('change', function () {
                        if (parseFloat(this.value) > 30) {
                            document.getElementById('weightModal').style.display = 'flex';
                            this.value = 30; // Reset to max allowed or clear? Resetting to 30 for safety.
                        }
                    });
                }

                /* ===== PAIEMENT SUMUP ===== */
                const btnPay = document.getElementById("btnPay");
                btnPay.onclick = async () => {
                    const form = document.getElementById("chronoForm");
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    // Validation minimale (comme RIB)
                    if (!data.receiverLastname || !data.receiverFirstname || !data.receiverEmail) {
                        alert("Veuillez remplir les informations obligatoires du destinataire (Nom, Prénom, Email).");
                        return;
                    }

                    // On sauvegarde les données pour les retrouver au retour du paiement
                    // Traitement de la date identique à handleSubmit
                    if (data.shippingDate_input) {
                        const parts = data.shippingDate_input.split('-');
                        if (parts.length === 3) {
                            const [y, m, d] = parts;
                            data.shippingDate = `${d}/${m}/${y}`;
                        }
                    }
                    delete data.shippingDate_input;

                    localStorage.setItem('chronoData', JSON.stringify(data));

                    const statusDiv = document.getElementById('statusMessage');
                    statusDiv.textContent = "Préparation du paiement...";
                    statusDiv.className = "";

                    try {
                        const API_BASE_PAY = "https://generate-docs-production.up.railway.app";
                        const res = await fetch(`${API_BASE_PAY}/create-payment?product_name=chrono-13`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                type_pdf: "chrono13",
                                ...data
                            })
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || "Erreur lors de la création du paiement");
                        }

                        const result = await res.json();
                        if (result.payment_url) {
                            window.location.href = result.payment_url;
                        } else {
                            throw new Error("Pas d'URL de paiement reçue");
                        }
                    } catch (err) {
                        statusDiv.textContent = "Erreur Paiement: " + err.message;
                        statusDiv.className = "error-message";
                    }
                };

            } catch (err) {
                console.error("Critical JS Error:", err);
                const statusDiv = document.getElementById('statusMessage');
                if (statusDiv) {
                    statusDiv.textContent = "Erreur chargement script: " + err.message;
                    statusDiv.className = "error-message";
                }
            }
        });

        function closeWeightModal() {
            document.getElementById('weightModal').style.display = 'none';
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Date processing
            if (data.shippingDate_input) {
                const parts = data.shippingDate_input.split('-');
                if (parts.length === 3) {
                    const [y, m, d] = parts;
                    data.shippingDate = `${d}/${m}/${y}`;
                }
            }
            delete data.shippingDate_input;
            
            // Mark as preview for the free version
            data.preview = true;

            performGeneration(data);
        }

        async function performGeneration(data) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = '';
            statusDiv.className = '';

            const overlay = document.getElementById('overlay');
            if (overlay) overlay.style.visibility = 'visible';

            const btn = document.getElementById('btn-validate');
            const timerContainer = document.getElementById('timerContainer');
            const timerSpan = document.getElementById('timer');

            if (btn) btn.disabled = true;
            if (btn) btn.textContent = "Génération en cours... (Ne quittez pas !)";

            timerContainer.style.display = 'block';
            let seconds = 0;
            timerSpan.textContent = "00:00";

            let timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                timerSpan.textContent = `${m}:${s}`;
            }, 1000);

            try {
                const response = await fetch('https://chronopost.up.railway.app/generate-chronopost/generate-chronopost', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data })
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    statusDiv.textContent = "Génération réussie ! Le bordereau a été envoyé par mail.";
                    statusDiv.className = "success-message";
                } else {
                    const msg = result.message || "Erreur inconnue du serveur";
                    throw new Error(msg);
                }

            } catch (error) {
                console.error(error);
                statusDiv.textContent = "Erreur: " + error.message;
                statusDiv.className = "error-message";
            } finally {
                if (overlay) overlay.style.visibility = 'hidden';
                if (timerInterval) clearInterval(timerInterval);
                if (timerContainer) timerContainer.style.display = 'none';

                if (btn) {
                    btn.disabled = false;
                    btn.textContent = "Générer Preview (Gratuit)";
                }
            }
        }
    </script>
</body>

</html>