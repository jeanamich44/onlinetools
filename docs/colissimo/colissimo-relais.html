<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Colissimo Point de Retrait - Relais & Consignes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        .relay-explorer {
            display: block !important;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-top: 15px;
            width: 100%;
            overflow: hidden;
        }

        .relay-search-zone {
            padding: 15px;
            background: #0d1117;
            border-bottom: 1px solid #30363d;
        }


        .map-search-grid {
            display: grid !important;
            grid-template-columns: 1fr 120px;
            gap: 10px;
            width: 100%;
        }

        #mapZipInput {
            width: 100% !important;
            height: 42px !important;
            background: #0d1117 !important;
            border: 1px solid #30363d !important;
            color: white !important;
            padding: 0 12px !important;
            border-radius: 4px !important;
            box-sizing: border-box !important;
        }

        #btnSearchRelay {
            width: 100% !important;
            height: 42px !important;
            background: #0099ff !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            font-weight: bold !important;
            cursor: pointer !important;
        }

        .relay-map-cont {
            height: 350px;
            width: 100%;
            border-bottom: 1px solid #30363d;
            position: relative;
            z-index: 1;
        }

        #relayMap {
            height: 100%;
            width: 100%;
        }

        .relay-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #0d1117;
        }

        .relay-card {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .relay-card:hover,
        .relay-card.active {
            border-color: #0099ff;
        }

        .relay-card-title {
            color: #0099ff;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
        }

        .relay-distance {
            font-size: 0.8rem;
            color: #8b949e;
            background: #30363d;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .relay-card-address {
            font-size: 0.85rem;
            color: #c9d1d9;
            margin: 6px 0;
        }

        .relay-card-select-btn {
            width: 100%;
            background: #238636;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        input.input-invalid {
            border-color: #ff4444 !important;
        }

        .leaflet-popup-content-wrapper {
            background: #1f242d !important;
            color: #fff !important;
            border-radius: 8px !important;
        }

        .leaflet-popup-tip {
            background: #1f242d !important;
        }

        .relay-popup b {
            color: #0099ff !important;
        }
    </style>
</head>

<body>

    <div id="overlay" style="flex-direction: column; gap: 20px;">
        <div class="spinner"></div>
        <div id="timerContainer" style="display:none; text-align: center; color: #fff;">
            <span style="font-size: 1.2rem; font-weight: bold;" id="timer">00:00</span>
            <span class="info-icon" style="margin-left: 10px; vertical-align: middle;"
                data-tooltip="La génération est en cours. Veuillez patienter quelques instants.">i</span>
        </div>
    </div>

    <header class="header">
        <div class="header-inner">
            <a href="../index.html" class="logo">ChezRheyy</a>
            <nav class="nav">
                <a href="../index.html">Home</a>
                <a href="../contact.html">Contact</a>
            </nav>
        </div>
    </header>

    <main class="content form-container">

        <h1 class="page-title">Colissimo - Livraison en Point de Retrait (Relais)</h1>

        <form id="colissimoForm" onsubmit="handleSubmit(event)" novalidate>
            <input type="hidden" name="productCode" value="COL">

            <div class="sections-grid">

                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">1</span> Expéditeur</span>
                        <span>FRANCE</span>
                    </div>
                    <div class="section-content">
                        <div class="radio-group" style="margin-bottom: 20px;">
                            <label>Type *</label>
                            <label><input type="radio" name="senderType" value="0"> Professionnel</label>
                            <label><input type="radio" name="senderType" value="1" checked> Particulier</label>
                        </div>

                        <div class="form-group" id="senderCompanyDiv" style="display:none;">
                            <label>Nom de société</label>
                            <input type="text" name="senderCompanyName" placeholder="Optionnel" maxlength="60">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" name="senderLastname" placeholder="Nom" maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Prénom</label>
                                <input type="text" name="senderFirstname" placeholder="Prénom" maxlength="60">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>E-mail</label>
                                <input type="email" name="senderEmail" placeholder="votre@email.com" maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Téléphone</label>
                                <input type="tel" name="senderPhone" placeholder="06..." maxlength="14">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Code Postal</label>
                                <input type="text" name="senderCP" required pattern="\d+" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label>Ville</label>
                                <input type="text" name="senderCity" required maxlength="60">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Adresse</label>
                            <input type="text" name="senderAddress" required maxlength="100">
                        </div>
                        <input type="hidden" name="senderCountry" value="FR">
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">2</span> Destinataire & Point Relais</span>
                    </div>
                    <div class="section-content">
                        <div class="radio-group" style="margin-bottom: 20px;">
                            <label>Type *</label>
                            <label><input type="radio" name="receiverType" value="0"> Professionnel</label>
                            <label><input type="radio" name="receiverType" value="1" checked> Particulier</label>
                        </div>

                        <div class="form-group" id="receiverCompanyDiv" style="display:none;">
                            <label>Nom de société</label>
                            <input type="text" name="receiverCompanyName" placeholder="Optionnel" maxlength="60">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom *</label>
                                <input type="text" name="receiverLastname" required maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Prénom *</label>
                                <input type="text" name="receiverFirstname" required maxlength="60">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>E-mail *</label>
                                <input type="email" name="receiverEmail" required placeholder="client@email.com"
                                    maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Téléphone *</label>
                                <input type="tel" name="receiverPhone" required placeholder="06..." maxlength="14">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label style="color: #ffcc00; font-weight: bold;">ID Point de Retrait *</label>
                                <input type="text" name="pickupLocationId" id="pickupLocationId" required
                                    placeholder="Ex: 054238" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label>Type Relais</label>
                                <select name="pickupLocationType" id="pickupLocationType">
                                    <option value="A2P">Relais Pickup</option>
                                    <option value="BPR">Bureau de Poste</option>
                                    <option value="PCS">Consigne Pickup</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label>Rechercher un point relais (Colissimo)</label>

                            <div class="relay-explorer">
                                <div class="relay-search-zone">
                                    <div class="map-search-grid">
                                        <input type="text" id="mapZipInput" placeholder="CP (ex: 75001)" maxlength="5">
                                        <button type="button" id="btnSearchRelay">Chercher</button>
                                    </div>
                                    <div id="mapSearchMsg" style="margin-top:5px;"></div>
                                </div>
                                <div class="relay-map-cont">
                                    <div id="relayMap"></div>
                                </div>
                                <div id="relayList" class="relay-list">
                                    <div style="text-align:center; padding:20px; color:#8b949e;">Entrez un code postal.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="receiverAddress" value="POINT RELAIS">
                        <input type="hidden" name="receiverCity" value="TRANSIT">
                        <input type="hidden" name="receiverCP" value="00000">
                        <input type="hidden" name="receiverCountry" value="FR">
                    </div>
                </div>
            </div>

            <div class="sections-grid">
                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">3</span> Colis & Référence</span>
                    </div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Poids (kg) *</label>
                                <input type="number" name="packageWeight" required step="0.1" placeholder="Ex: 1.5"
                                    min="0.1" max="30">
                            </div>
                            <div class="form-group">
                                <label>Date d'envoi</label>
                                <input type="date" name="shippingDate" id="shippingDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Référence Interne (Optionnel)</label>
                            <input type="text" name="orderNumber" placeholder="Ex: CMD-1234" maxlength="30">
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button type="submit" class="btn-validate" id="btn-validate"
                    style="background-color: #28a745; width: 100%; color: white; border: none; padding: 15px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">Générer
                    l'étiquette Relais</button>
            </div>

            <div id="message"></div>
        </form>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="../js/chronopost-autocomplete.js"></script>
        <a class="back" href="./colissimo-liste.html">Retour</a>
    </main>

    <script>
        const DEFAULT_SENDER = {
            lastname: "Dupont",
            firstname: "Jean",
            cp: "75001",
            city: "Paris",
            address: "10 rue de la Paix"
        };

        function fillDefaultSender() {
            document.querySelector('input[name="senderLastname"]').value = DEFAULT_SENDER.lastname;
            document.querySelector('input[name="senderFirstname"]').value = DEFAULT_SENDER.firstname;
            document.querySelector('input[name="senderCP"]').value = DEFAULT_SENDER.cp;
            document.querySelector('input[name="senderCity"]').value = DEFAULT_SENDER.city;
            document.querySelector('input[name="senderAddress"]').value = DEFAULT_SENDER.address;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const statusDiv = document.getElementById('message');
            const overlay = document.getElementById('overlay');
            const btn = document.getElementById('btn-validate');

            statusDiv.innerHTML = "";
            statusDiv.className = "";

            let firstInvalid = null;
            form.querySelectorAll('input, select, textarea').forEach(input => {
                if (input.hasAttribute('required') || input.hasAttribute('pattern')) {
                    const isValid = input.checkValidity();
                    let errorSpan = input.parentNode.querySelector('.validation-error-msg');

                    if (!isValid) {
                        input.classList.add('input-invalid');
                        if (!errorSpan) {
                            errorSpan = document.createElement('span');
                            errorSpan.className = 'validation-error-msg';
                            input.parentNode.appendChild(errorSpan);
                        }
                        errorSpan.textContent = input.validationMessage;
                        if (!firstInvalid) firstInvalid = input;
                    } else {
                        input.classList.remove('input-invalid');
                        if (errorSpan) errorSpan.remove();
                    }
                }
            });

            if (firstInvalid) {
                firstInvalid.focus();
                return;
            }

            statusDiv.textContent = "Traitement en cours...";
            btn.disabled = true;
            overlay.style.visibility = 'visible';

            try {
                const response = await fetch('https://transporteur.up.railway.app/generate/colissimo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data })
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    statusDiv.innerHTML = "<span class='success-message'>✅ Génération réussie !</span>";
                    if (result.label) {
                        const link = document.createElement("a");
                        link.href = `data:application/pdf;base64,${result.label}`;
                        link.download = `etiquette_relais_${result.parcelNumber || 'test'}.pdf`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                } else {
                    statusDiv.innerHTML = "<span class='error-message'>❌ Erreur: " + (result.message || "Erreur serveur") + "</span>";
                }
            } catch (error) {
                statusDiv.innerHTML = "<span class='error-message'>❌ Erreur réseau ou serveur.</span>";
            } finally {
                overlay.style.visibility = 'hidden';
                btn.disabled = false;
            }
        }

        function setupVisibilityToggle(radioName, divId) {
            const radios = document.getElementsByName(radioName);
            const targetDiv = document.getElementById(divId);

            if (!targetDiv) return;

            function update() {
                const checked = document.querySelector(`input[name="${radioName}"]:checked`);
                if (checked) {
                    targetDiv.style.display = (checked.value === "0") ? "block" : "none";
                }
            }

            radios.forEach(r => r.addEventListener('change', update));
            update();
        }

        let map;
        let markersLayer;

        function initMap() {
            map = L.map('relayMap').setView([46.603354, 1.888334], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        }


        const orangeIcon = L.divIcon({
            className: 'custom-icon',
            html: `<svg width="34" height="43" viewBox="0 0 34 43" version="1.1" xmlns="http://www.w3.org/2000/svg"><defs><path d="M26.687 34.988C31.228 29.799 33.851 23.803 33.851 16.975S26.274 0 16.926 0C7.577 0 0 7.600 0 16.975C0 23.802 2.623 29.797 7.163 34.986C10.245 38.509 13.748 41.18 16.924 43C20.099 41.182 23.604 38.511 26.687 34.988Z" id="path-1"/></defs><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="orange-pin"><mask id="mask-2" fill="white"><use xlink:href="#path-1"/></mask><use id="Path-base" fill="#ED7203" fill-rule="nonzero" xlink:href="#path-1"/><path d="M16.707 9.06ZM9.405 13.047L17.585 17.809C17.661 17.85 17.719 17.949 17.719 18.038L17.719 18.038L17.719 24.985C17.719 25.073 17.656 25.173 17.58 25.214L17.58 25.214L17.14 25.458C17.103 25.478 17.057 25.488 17.008 25.488L17.008 25.488L16.999 25.488C16.946 25.489 16.897 25.479 16.859 25.458L16.859 25.458L16.417 25.214C16.342 25.174 16.281 25.073 16.281 24.985L16.281 24.985L16.281 18.792C16.277 18.747 16.244 18.691 16.208 18.67L16.208 18.67L9 14.475L9 22.693C9 22.877 9.13 23.104 9.289 23.197L16.712 27.575C16.791 27.621 16.896 27.644 17 27.644C17.105 27.644 17.209 27.622 17.288 27.575L24.713 23.197C24.871 23.103 25 22.877 25 22.693L25 22.693L25 14.475L20.115 17.321C20.04 17.365 19.922 17.361 19.848 17.316L19.415 17.058C19.38 17.036 19.348 17.002 19.323 16.959C19.322 16.957 19.32 16.955 19.319 16.952L19.319 16.952C19.291 16.907 19.276 16.859 19.274 16.816L19.274 16.816L19.263 16.311C19.26 16.226 19.315 16.122 19.391 16.078L24.596 13.047L17.293 9.066C17.212 9.022 11.106 9.000 17 9C17 9 17 9 17 9C16.893 9 16.787 9.022 16.707 9.066" id="Fill-box" fill="#FFFFFF" mask="url(#mask-2)"/></g></g></svg>`,
            iconSize: [34, 43],
            iconAnchor: [17, 43],
            popupAnchor: [0, -40]
        });

        const yellowIcon = L.divIcon({
            className: 'custom-icon',
            html: `<svg width="35" height="44" viewBox="0 0 35 44" version="1.1" xmlns="http://www.w3.org/2000/svg"><defs><path d="M27.262 35.907C31.802 30.718 34.426 24.722 34.426 17.894C34.426 8.518 26.249 0.919 17.5 0.919C8.151 0.919 0.574 8.518 0.574 17.894C0.574 24.7203 3.197 30.716 7.737 35.905C10.82 39.428 14.323 42.099 17.498 43.919C20.673 42.101 24.179 39.43 27.262 35.907Z" id="path-1"/><path d="M13.746 4.604C12.649 6.15 11.874 6.794 11.285 7.148C10.981 7.331 10.582 7.352 10.457 7.354L10.418 7.354L1.989 7.5Z" id="path-3"/></defs><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="yellow-pin"><mask id="mask-2" fill="white"><use xlink:href="#path-1"/></mask><use id="Path-base-y" fill="#FFC928" fill-rule="nonzero" xlink:href="#path-1"/><g id="Icons/Post-Office-Logo" transform="translate(7, 15)"><mask id="mask-4" fill="white"><use xlink:href="#path-3"/></mask><use id="ic_bureau-poste" fill="#3C3434" xlink:href="#path-3"/><g id="Color" mask="url(#mask-4)" fill="#393939"><g transform="translate(-12, -17.28)" id="Rectangle"><rect x="0" y="0" width="53" height="53"/></g></g></g></g></g></svg>`,
            iconSize: [35, 44],
            iconAnchor: [17, 44],
            popupAnchor: [0, -40]
        });

        let relayMarkers = {};

        async function searchRelays() {
            const zipInput = document.getElementById('mapZipInput');
            const zip = zipInput.value;
            const msgDiv = document.getElementById('mapSearchMsg');
            const listDiv = document.getElementById('relayList');

            if (!zip || zip.length < 5) {
                msgDiv.innerHTML = "<span class='validation-error-msg'>Code postal invalide.</span>";
                zipInput.classList.add('input-invalid');
                return;
            }

            msgDiv.innerHTML = "<span style='color: #0099ff; font-size:0.85rem;'>Recherche...</span>";
            listDiv.innerHTML = "<div style='text-align:center; padding-top:20px;'><div class='spinner' style='width:30px; height:30px; margin:0 auto;'></div></div>";
            zipInput.classList.remove('input-invalid');

            try {
                const resp = await fetch(`https://transporteur.up.railway.app/relay/search?zip=${zip}&type=colissimo`);

                if (resp.status === 404) {
                    msgDiv.innerHTML = "<span class='validation-error-msg'>Service non déployé (404).</span>";
                    listDiv.innerHTML = "<div style='padding:15px; color:#ff4444;'>L'API n'est pas encore prête sur le serveur. Veuillez patienter ou entrer l'ID manuellement.</div>";
                    return;
                }

                const data = await resp.json();
                markersLayer.clearLayers();
                listDiv.innerHTML = "";
                relayMarkers = {};

                if (data.status === 'success' && data.relays && data.relays.length > 0) {
                    msgDiv.innerHTML = `<span style='color: #28a745; font-size:0.85rem;'>✅ ${data.relays.length} points trouvés.</span>`;
                    const bounds = L.latLngBounds();

                    data.relays.forEach(relay => {


                        let activeIcon = orangeIcon;
                        if (relay.type === 'BPR') activeIcon = yellowIcon;

                        const marker = L.marker([relay.lat, relay.lng], { icon: activeIcon });
                        const popupContent = `
                            <div class="relay-popup">
                                <b>${relay.name}</b><br>
                                ${relay.address}<br>
                                ${relay.zip} ${relay.city}<br>
                                <button type="button" class="relay-select-btn" onclick="selectRelay('${relay.id}', '${relay.type}')">Sélectionner ce point</button>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                        markersLayer.addLayer(marker);
                        relayMarkers[relay.id] = marker;

                        if (relay.lat && relay.lng) bounds.extend([relay.lat, relay.lng]);

                        const card = document.createElement("div");
                        card.className = "relay-card";
                        card.id = `card-${relay.id}`;
                        const distText = relay.distance > 0 ? `<span class="relay-distance">${relay.distance.toFixed(1)} km</span>` : '';

                        card.innerHTML = `
                            <div class="relay-card-title">
                                <span>${relay.name}</span>
                                ${distText}
                            </div>
                            <div class="relay-card-address">${relay.address}<br>${relay.zip} ${relay.city}</div>
                            <button type="button" class="relay-card-select-btn" onclick="event.stopPropagation(); selectRelay('${relay.id}', '${relay.type}')">Choisir ce point</button>
                        `;

                        card.onclick = () => {
                            marker.openPopup();
                            map.setView([relay.lat, relay.lng], 15);
                            document.querySelectorAll('.relay-card').forEach(c => c.classList.remove('active'));
                            card.classList.add('active');
                        };

                        listDiv.appendChild(card);
                    });

                    map.fitBounds(bounds, { padding: [20, 20] });
                } else {
                    msgDiv.innerHTML = "<span class='validation-error-msg'>Aucun résultat.</span>";
                    listDiv.innerHTML = "<div style='text-align:center; padding-top:20px; color:#8b949e;'>Aucun point relais trouvé ici.</div>";
                }
            } catch (e) {
                console.error("Map search error", e);
                msgDiv.innerHTML = "<span class='validation-error-msg'>Erreur réseau.</span>";
                listDiv.innerHTML = "<div style='padding:15px; color:#ff4444;'>Erreur lors de la récupération des données.</div>";
            }
        }

        window.selectRelay = function (id, type) {
            document.getElementById('pickupLocationId').value = id;
            if (type) {
                document.getElementById('pickupLocationType').value = type;
            }

            const input = document.getElementById('pickupLocationId');
            input.style.backgroundColor = 'rgba(40, 167, 69, 0.2)';
            setTimeout(() => input.style.backgroundColor = '', 1000);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const shippingDateInput = document.getElementById('shippingDate');
            if (shippingDateInput) shippingDateInput.value = today;

            setupVisibilityToggle('senderType', 'senderCompanyDiv');
            setupVisibilityToggle('receiverType', 'receiverCompanyDiv');

            fillDefaultSender();
            initMap();

            document.getElementById('btnSearchRelay').addEventListener('click', searchRelays);
            document.getElementById('mapZipInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchRelays();
                }
            });
        });
    </script>
</body>

</html>