<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Colissimo Point de Retrait - Relais & Consignes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        .relay-explorer {
            display: block !important;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-top: 15px;
            width: 100%;
            overflow: hidden;
        }

        .relay-search-zone {
            padding: 15px;
            background: #0d1117;
            border-bottom: 1px solid #30363d;
        }


        .map-search-grid {
            display: grid !important;
            grid-template-columns: 1fr 120px;
            gap: 10px;
            width: 100%;
        }

        #mapZipInput {
            width: 100% !important;
            height: 42px !important;
            background: #0d1117 !important;
            border: 1px solid #30363d !important;
            color: white !important;
            padding: 0 12px !important;
            border-radius: 4px !important;
            box-sizing: border-box !important;
        }

        #btnSearchRelay {
            width: 100% !important;
            height: 42px !important;
            background: #0099ff !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            font-weight: bold !important;
            cursor: pointer !important;
        }

        .relay-map-cont {
            height: 350px;
            width: 100%;
            border-bottom: 1px solid #30363d;
            position: relative;
            z-index: 1;
        }

        #relayMap {
            height: 100%;
            width: 100%;
        }

        .relay-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #0d1117;
        }

        .relay-card {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .relay-card:hover,
        .relay-card.active {
            border-color: #0099ff;
        }

        .relay-card-title {
            color: #0099ff;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
        }

        .relay-distance {
            font-size: 0.8rem;
            color: #8b949e;
            background: #30363d;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .relay-card-address {
            font-size: 0.85rem;
            color: #c9d1d9;
            margin: 6px 0;
        }

        .relay-card-select-btn {
            width: 100%;
            background: #238636;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        input.input-invalid {
            border-color: #ff4444 !important;
        }

        .leaflet-popup-content-wrapper {
            background: #1f242d !important;
            color: #fff !important;
            border-radius: 8px !important;
        }

        .leaflet-popup-tip {
            background: #1f242d !important;
        }

        .relay-popup b {
            color: #0099ff !important;
        }
    </style>
</head>

<body>

    <div id="overlay" style="flex-direction: column; gap: 20px;">
        <div class="spinner"></div>
        <div id="timerContainer" style="display:none; text-align: center; color: #fff;">
            <span style="font-size: 1.2rem; font-weight: bold;" id="timer">00:00</span>
            <span class="info-icon" style="margin-left: 10px; vertical-align: middle;"
                data-tooltip="La génération est en cours. Veuillez patienter quelques instants.">i</span>
        </div>
    </div>

    <header class="header">
        <div class="header-inner">
            <a href="../index.html" class="logo">ChezRheyy</a>
            <nav class="nav">
                <a href="../index.html">Home</a>
                <a href="../contact.html">Contact</a>
            </nav>
        </div>
    </header>

    <main class="content form-container">

        <h1 class="page-title">Colissimo - Livraison en Point de Retrait (Relais)</h1>

        <form id="colissimoForm" onsubmit="handleSubmit(event)" novalidate>
            <input type="hidden" name="productCode" value="COL">

            <div class="sections-grid">

                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">1</span> Expéditeur</span>
                        <span>FRANCE</span>
                    </div>
                    <div class="section-content">
                        <div class="radio-group" style="margin-bottom: 20px;">
                            <label>Type *</label>
                            <label><input type="radio" name="senderType" value="0"> Professionnel</label>
                            <label><input type="radio" name="senderType" value="1" checked> Particulier</label>
                        </div>

                        <div class="form-group" id="senderCompanyDiv" style="display:none;">
                            <label>Nom de société</label>
                            <input type="text" name="senderCompanyName" placeholder="Optionnel" maxlength="60">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" name="senderLastname" placeholder="Nom" maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Prénom</label>
                                <input type="text" name="senderFirstname" placeholder="Prénom" maxlength="60">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>E-mail</label>
                                <input type="email" name="senderEmail" placeholder="votre@email.com" maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Téléphone</label>
                                <input type="tel" name="senderPhone" placeholder="06..." maxlength="14">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Code Postal</label>
                                <input type="text" name="senderCP" required pattern="\d+" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label>Ville</label>
                                <input type="text" name="senderCity" required maxlength="60">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Adresse</label>
                            <input type="text" name="senderAddress" required maxlength="100">
                        </div>
                        <input type="hidden" name="senderCountry" value="FR">
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">2</span> Destinataire & Point Relais</span>
                    </div>
                    <div class="section-content">
                        <div class="radio-group" style="margin-bottom: 20px;">
                            <label>Type *</label>
                            <label><input type="radio" name="receiverType" value="0"> Professionnel</label>
                            <label><input type="radio" name="receiverType" value="1" checked> Particulier</label>
                        </div>

                        <div class="form-group" id="receiverCompanyDiv" style="display:none;">
                            <label>Nom de société</label>
                            <input type="text" name="receiverCompanyName" placeholder="Optionnel" maxlength="60">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom *</label>
                                <input type="text" name="receiverLastname" required maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Prénom *</label>
                                <input type="text" name="receiverFirstname" required maxlength="60">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>E-mail *</label>
                                <input type="email" name="receiverEmail" required placeholder="client@email.com"
                                    maxlength="60">
                            </div>
                            <div class="form-group">
                                <label>Téléphone *</label>
                                <input type="tel" name="receiverPhone" required placeholder="06..." maxlength="14">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label style="color: #ffcc00; font-weight: bold;">ID Point de Retrait *</label>
                                <input type="text" name="pickupLocationId" id="pickupLocationId" required
                                    placeholder="Ex: 054238" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label>Type Relais</label>
                                <select name="pickupLocationType" id="pickupLocationType">
                                    <option value="A2P">Relais Pickup</option>
                                    <option value="BPR">Bureau de Poste</option>
                                    <option value="PCS">Consigne Pickup</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label>Rechercher un point relais (Colissimo)</label>

                            <div class="relay-explorer">
                                <div class="relay-search-zone">
                                    <div class="map-search-grid">
                                        <input type="text" id="mapZipInput" placeholder="CP (ex: 75001)" maxlength="5">
                                        <button type="button" id="btnSearchRelay">Chercher</button>
                                    </div>
                                    <div id="mapSearchMsg" style="margin-top:5px;"></div>
                                </div>
                                <div class="relay-map-cont">
                                    <div id="relayMap"></div>
                                </div>
                                <div id="relayList" class="relay-list">
                                    <div style="text-align:center; padding:20px; color:#8b949e;">Entrez un code postal.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="receiverAddress" value="POINT RELAIS">
                        <input type="hidden" name="receiverCity" value="TRANSIT">
                        <input type="hidden" name="receiverCP" value="00000">
                        <input type="hidden" name="receiverCountry" value="FR">
                    </div>
                </div>
            </div>

            <div class="sections-grid">
                <div class="form-section">
                    <div class="section-header">
                        <span><span class="section-number">3</span> Colis & Référence</span>
                    </div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Poids (kg) *</label>
                                <input type="number" name="packageWeight" required step="0.1" placeholder="Ex: 1.5"
                                    min="0.1" max="30">
                            </div>
                            <div class="form-group">
                                <label>Date d'envoi</label>
                                <input type="date" name="shippingDate" id="shippingDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Référence Interne (Optionnel)</label>
                            <input type="text" name="orderNumber" placeholder="Ex: CMD-1234" maxlength="30">
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button type="submit" class="btn-validate" id="btn-validate"
                    style="background-color: #28a745; width: 100%; color: white; border: none; padding: 15px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; font-weight: bold;">Générer
                    l'étiquette Relais</button>
            </div>

            <div id="message"></div>
        </form>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="../js/chronopost-autocomplete.js"></script>
        <a class="back" href="./colissimo-liste.html">Retour</a>
    </main>

    <script>
        const DEFAULT_SENDER = {
            lastname: "Dupont",
            firstname: "Jean",
            cp: "75001",
            city: "Paris",
            address: "10 rue de la Paix"
        };

        function fillDefaultSender() {
            document.querySelector('input[name="senderLastname"]').value = DEFAULT_SENDER.lastname;
            document.querySelector('input[name="senderFirstname"]').value = DEFAULT_SENDER.firstname;
            document.querySelector('input[name="senderCP"]').value = DEFAULT_SENDER.cp;
            document.querySelector('input[name="senderCity"]').value = DEFAULT_SENDER.city;
            document.querySelector('input[name="senderAddress"]').value = DEFAULT_SENDER.address;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const statusDiv = document.getElementById('message');
            const overlay = document.getElementById('overlay');
            const btn = document.getElementById('btn-validate');

            statusDiv.innerHTML = "";
            statusDiv.className = "";

            let firstInvalid = null;
            form.querySelectorAll('input, select, textarea').forEach(input => {
                if (input.hasAttribute('required') || input.hasAttribute('pattern')) {
                    const isValid = input.checkValidity();
                    let errorSpan = input.parentNode.querySelector('.validation-error-msg');

                    if (!isValid) {
                        input.classList.add('input-invalid');
                        if (!errorSpan) {
                            errorSpan = document.createElement('span');
                            errorSpan.className = 'validation-error-msg';
                            input.parentNode.appendChild(errorSpan);
                        }
                        errorSpan.textContent = input.validationMessage;
                        if (!firstInvalid) firstInvalid = input;
                    } else {
                        input.classList.remove('input-invalid');
                        if (errorSpan) errorSpan.remove();
                    }
                }
            });

            if (firstInvalid) {
                firstInvalid.focus();
                return;
            }

            statusDiv.textContent = "Traitement en cours...";
            btn.disabled = true;
            overlay.style.visibility = 'visible';

            try {
                const response = await fetch('https://transporteur.up.railway.app/generate/colissimo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data })
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    statusDiv.innerHTML = "<span class='success-message'>✅ Génération réussie !</span>";
                    if (result.label) {
                        const link = document.createElement("a");
                        link.href = `data:application/pdf;base64,${result.label}`;
                        link.download = `etiquette_relais_${result.parcelNumber || 'test'}.pdf`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                } else {
                    statusDiv.innerHTML = "<span class='error-message'>❌ Erreur: " + (result.message || "Erreur serveur") + "</span>";
                }
            } catch (error) {
                statusDiv.innerHTML = "<span class='error-message'>❌ Erreur réseau ou serveur.</span>";
            } finally {
                overlay.style.visibility = 'hidden';
                btn.disabled = false;
            }
        }

        function setupVisibilityToggle(radioName, divId) {
            const radios = document.getElementsByName(radioName);
            const targetDiv = document.getElementById(divId);

            if (!targetDiv) return;

            function update() {
                const checked = document.querySelector(`input[name="${radioName}"]:checked`);
                if (checked) {
                    targetDiv.style.display = (checked.value === "0") ? "block" : "none";
                }
            }

            radios.forEach(r => r.addEventListener('change', update));
            update();
        }

        let map;
        let markersLayer;

        function initMap() {
            map = L.map('relayMap').setView([46.603354, 1.888334], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        }

        // Icônes Officielles La Poste
        const orangeIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzRweCIgaGVpZ2h0PSI0M3B4IiB2aWV3Qm94PSIwIDAgMzQgNDMiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PGRlZnM+PHBhdGggZD0iTTI2LjY4NzMwNDIsMzQuOTg4MDA4IEMzMS4yMjc4MSwyOS43OTkxODExIDMzLjg1MTA2MzgsMjMuODAzMzI2NyAzMy44NTEwNjM4LDE2Ljk3NTA2ODkgQzMzLjg1MTA2MzgsNy41OTkwOTc1MyAyNi4yNzQxNDIxLDAgMTYuOTI1NTMxOSwwIEM3LjU3NjkyMTcsMCAwLDcuNTk5MDk3NTMgMCwxNi45NzUwNjg5IEMwLDIzLjgwMTUxMjQgMi42MjI4NTk3OSwyOS43OTY2Mjg4IDcuMTYyODI2ODYsMzQuOTg1Nzk5NSBDMTAuMjQ1MTQ1MywzOC41MDg4ODE2IDEzLjc0ODQ0NDQsNDEuMTc5NjIzOSAxNi45MjM4NjY4LDQzIEMyMC4wOTg4NDI0LDQxLjE4MjQ3MzEgMjMuNjA0NDczNCwzOC41MTEwMjQyIDI2LjY4NzMwNDIsMzQuOTg4MDA4IFoiIGlkPSJwYXRoLTEiPjwvcGF0aD48L2RlZnM+PGcgaWQ9Ii0tLS3ilJctLUd1aWRlcyIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+PGcgaWQ9IipHdWlkZXMvVGVhc2Vycy9BY2UiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xMDEuMDAwMDAwLCAtNjM5LjAwMDAwMCkiPjxnIGlkPSJHcm91cCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTAwLjAwMDAwMCwgNjM4LjAwMDAwMCkiPjxnIGlkPSJJY29ucy9QaW4tbWFwXzM3X1llbGxvd19EZWZhdWx0LSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS4wMDAwMDAsIDEuMDAwMDAwKSI+PG1hc2sgaWQ9Im1hc2stMiIgZmlsbD0id2hpdGUiPjx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+PC9tYXNrPjx1c2UgaWQ9IlBhdGgtIiBmaWxsPSIjRUQ3MjAzIiBmaWxsLXJ1bGU9Im5vbnplcm8iIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPjxwYXRoIGQ9Ik0xNi43MDcyMTU1LDkuMDY2MzYxODIgTDkuNDA0NDg4MDEsMTMuMDQ2NTMwMiBMMTcuNTg1NDM2NiwxNy44MDkwNDE4IEMxNy42NjEyMTksMTcuODUwNDY1NiAxNy43MTg4ODY2LDE3Ljk0ODk2MjkgMTcuNzE4ODg2NiwxOC4wMzc3MzE0IEwxNy43MTg4ODY2LDE4LjAzNzczMTQgTDE3L3cxODg0MjYsMjQuOTg1MzYyNyBDMTcuNzE4ODQyNiwyNS4wNzI2NTY1IDE3LjY1NjQ0MjcsMjUuMTcyOTU4NiAxNy41ODAxMTAxLDI1LjIxMzU5MDEgTDE3LjU4MDExMDEsMjUuMjEzNTkwMSBMMTcuMTM5ODExLDI1LjQ1ODEwNTQgQzE3LjEwMzIyOTQsMjUuNDc3NTg0NyAxNy4wNTY3MjExLDI1LjQ4NzkwNzYgMTcuMDA4MDU1OCwyNS40ODc5MDc2IEwxNy4wMDgwNTU4LDI1LjQ4NzkwNzYgTDE2Ljk5OTY0NzgsMjUuNDg3OTA3NiBDMTYuOTQ2NzM0NCwyNS40ODkwNzQyIDE2Ljg5NzYwNjgsMjUuNDc4NzI5MiAxNi44NTkxMzI0LDI1LjQ1ODEwNTQgTDE2Ljg1kxMzI0LDI1LjQ1ODEwNTQgTDE2LjQxNzQ0NjYsMjUuMjEzNTI0MSBDMTYuMzQyMzAyNiwyNS4xNzM1OTY5IDE2LjI4MTAwMzIsMjUuMDcyOTQyNyAxNi4yODEwMDMyLDI0Ljk4NTM2MjcgTDE2LjI4MTAwMzIsMjQuOTg1MzYyNyBMMTYuMjgxMDY5MiwxOC43OTFkwzEgQzE2LjI3NzE1MTMsMTguNzQ2NTgxMyAxNi4yNDM5Mzc0LDE4LjY5MTIyNDggMTYuMjA3NTc2LDE4LjY3MDQwMjggTDE2LjI0NzU3NiwxOC42NzA0MDI4IEw5LDE0LjQ3NDcwNyBMOSwyMi42OTI3NDM0IEM5LDIyLjg3NjcyOTYgOS4xMjk1NTQxOSwyMy4xMDM1MjY0IDkuMjg4NTM2NDIsMjMuMTk2NDc2OSBMOS4yODg1MzY0MiwyMy4xOTY0NzY5IEwxNi43MTE2Mzk3LDI3LjU3NDQ2NDEgQzE2Ljc5MTA3NTcsMjcuNjIwOTI4NCAxNi44OTU1ODE5LDI3LjY0NDAxNzUgMTcuMDAwMDQzOSwyNy42NDM3MzM5IEwxNy4wMDAwNDM5LDI3LjY0MzczMzkgQzE3LjEwNDU5NDEsMjcuNjQzNDIzMiAxNy4yMDkwNzgyLDI3LjYyMTU2NjcgMTcuMjg4MzYwMiwyNy41NzQ1MDgxIEwxNy4yODgzNjAyLDI3LjU3NDUwODEgTDI0LjcxMjU4NiwyMy4xOTY0NzY5IEMyNC44NzA4ODU5LDIzLjEwMjUzNTkgMjUuMDAwMTk3OSwyMi44NzY5Mjc3IDI1LDIyLjY5Mjc0MzQgTDI1LDIyLjY5Mjc0MzQgTDI1LDE0LjQ3NDcyOSBMMjAuMTE1MzA3NywxNy4zMjA2NDk2IEMyMC4wMzk5MjE1LDE3LjM2NDU4MjcgMTkuOTIxODc4OSwxNy4zNjExMjcgMTkuODQ4Mjc1NiwxNy4zMTU2NTMyIEwxOS44NDgyNzU2LDE3LjMxNTY1MzIgTDE5LjQxNTM1LDE3LjA1ODMwNTggQzE5LjM4MDEzMzIsMTcuMDM2NDcxMyAxOS4zNDc3NTU2LDE3LjAwMTQ5NjYgMTkuMzIzMjc5OSwxNi45NTk0NTY0IEwxOS4zMjMyNzk5LDE2Ljk1OTQ1NjQgQzE5LjMyMTg3MTIsMTYuOTU3MDc5MyAxOS4zMjA0NDA1LDE2Ljk1NDU0ODEgMTkuMzE5MDMxOSwxNi45NTIxMjY5IEwxOS4zMTkwMzE5LDE2Ljk1MjEyNjkgQzE5LjI5MTQwODYsMTYuOTA3MDQ5MyAxOS4yNzU2MjcsMTYuODU5NDE4NCAxOS4yNzQwNjQzLDE2LjgxNTc3MTUgTDE5LjI3NDA2NDMsMTYuODE1NzcxNSBMMTkuMjYzMDM3LDE2LjMxMTA0NzUgQzE5LjI1OTczNTQsMTYuMjI2MDIwNyAxOS4zMTU4MTgzLDE2LjEyMjMwNyAxOS4zOTE0NDY2LDE2LjA3ODI2MzkgTDE5LjM5MTQ0NjYsMTYuMDc4MjYzOSBMMjQuNTk1NTExOCwxMy4wNDY0ODYyIEwxNy4yOTI4MDYzLDkuMDY2MzYxODIgQzE3LjIxMjM3OTgsOS4wMjE2ODA0IDExLjEwNjI4ODksOS4wMDAyMjAxMSAxNy4wMDAxOTgsOSBMMTcuMDAwMTk4LDkgQzE2Ljk5OTcxMzgsOSAxNi45OTkyMjk2LDkgMTYuOTk4NzQ1Myw5IEwxNi45OTg3NDUzLDkgQzE2Ljg5MzAyODYsOSAxNi43ODczMTE5LDkuMDIyMTIwNjEgMTYuNzA3MjE1NSw5LjA2NjM2MTgyIiBpZD0iRmlsbC0xIiBmaWxsPSIjRkZGRkZGIiBtYXNrPSJ1cmwoI21hc2stMikiPjwvcGF0aD48L2c+PC9nPjwvZz48L2c+PC9zdmc+',
            iconSize: [34, 43],
            iconAnchor: [17, 43],
            popupAnchor: [0, -40]
        });

        const yellowIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzVweCIgaGVpZ2h0PSI0NHB4IiB2aWV3Qm94PSIwIDAgMzUgNDQiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PGRlZnM+PHBhdGggZD0iTTI3LjI2MTc3MjMsMzUuOTA2OTI2OSBDMzE4MDIyNzgxLDMwLjcxODEgMzQuNDI1NTMxOSwyNC43MjIyNDU2IDM0LjQyNTUzMTksMTcuODkzOTg3OCBDMzQuNDI1NTMxOSw4LjUxODAxNjQ0IDI2LjI0ODYxMDIsMC45MTg5MTg5MTkgMTcuNSwwLjkxODkxODkxOSBDOC4xNTEzODk3OCwwLjkxODkxODkxOSAwLjU3NDQ2ODA4NSw4LjUxODAxNjQ0IDAuNTczNDY4MDg1LDE3Ljg5Mzk4NzggQzAuNTc0NDY4MDg1LDI0LjcyMDQzMTQgMy4xOTczMjc4OCwzMC43MTU1NDc3IDcuNzM3Mjk0OTQsMzUuOTA0NzE4NSBDMTAuODE5NjEzMywzOS40Mjc4MDA1IDE0LjMyMjkxMjUsNDIuMDk4NTQyOSAxNy40OTgzMzQ5LDQzLjkxODkxODkgQzIwLjY3MzMxMDUsNDIuMTAxMzkyIDI0LjE3ODk0MTQsMzkuNDI5OTQzMSAyNy4yNjE3NzIzLDM1LjkwNjkyNjkgIFoiIGlkPSJwYXRoLTEiPjwvcGF0aD48cGF0aCBkPSJNMTMuNzQ1NjE1NCw0LjYwMzcxMzQ2IEMxMi42NDg1MSw2LjE1MDIzNzA3IDExLjg3NDIxNzQsNi43OTM4MjQ0IDExLjI4NTE5MzgsNy4xNDc4MjEzNiBDMTAuOTgwNTQ4NCw3LjMzMTA4ODIzIDEwLjU4MTk3NzIsNy4zNTIzMjg0NyAxMC40NTcxOTU5LDcuMzU0MzE3ODEgTDEwLjQxODEyMzYsNy4zNTQzNDM1MSBMMS45ODkxOTY1NCw3LjUgWiBNMTkuNTg2MDA3NSwyLjM1NDQ5Nzc1IEMxOS44MjQ4MjQxLDIuMzQ3Nzk4NyAxOS45OTE4NjIsMi40MjY1NjAzOSAxOS45OTk2ODksMi41NzAzOTg1NyBDMjAuMDA4MTg0LDIuNzI0NTcyNDMgMTkuODQxNTI3OSwyLjgzMzg2MjY1IDE5LjYzOTQ1OTYsMi44NzA0MjAzMiBDMTcuMDY3ODM4NSwzLjMzNTE0MzAxIDEzLjU1OTk0NTYsNC4xMDU1MzM3OSAxMC4wMDE3NTA0LDQuOTk2Njk4ODkgQzYuNTY1NTQwNjYsNS44NTczMzU0NSAzLjAzNzMxNjg3LDYuNzQyNzU4NDkgMS4xMTEwMzQ5Nyw3LjI0NTY2NTc3IEMwLjg5OTQyMTcxNiw3LjMwMDg4NTA5IDAuNzA3Mzc1NzcyLDcuMzQ3ODc0MTQgMC41MzY3MTA2ODksNy4zOTMzMzE5OCBDMC4xNTUyOTE0MDksNy40OTQ5NjYxNCAwLjA0MzYxNDU5MjMsNy40NDI5MDQ5NSAwLjAwODU4NDM0MzA5LDcuMzQyMzIzNSBDLTAuMDI2NDQ1OTA2MSw3LjI0MTc0MjA0IDAuMDUwMDA5NzYwNCw3LjE1NDM2NzI5IDAuMTYwMjU0ODIzLDcuMDk4MTkwOTYgQzAuMjk4MTgwNDYzLDcuMDI3NzU1MjMgMC43Mjc3MDY2OCw2Ljg3NTk3Mzg5IDAuOTY2MzMyMzU2LDYuNzg3NjQyMTMgQzEuOTY5NzA1Niw2LjQxNjg5NzU1IDMuOTAwMDkxODYsNS42ODU1NTI2NiA1LjQzNzg5MTE3LDQuOTUwMTg4MzQgQzYuODk1NzAzMTUsNC4yNTMwMDg2IDcuOTY2OTQxNTMsMy40NzMzMzQ4NSA3Ljk3MTIzNjc5LDIuNjYyMDc5ODYgQzcuOTcxODA5NSwyLjU2MTc4NTUgNy45OTg4MjE5MiwyLjU0MDUzOTk1IDguMDkxNjk1MDQsMi41MzY5MDMzMiBDOC4yNjQ2NTA5MywyLjUzMDIwNDI3IDE5LjQxNjk2NTEsMi4zNTkxODcwOCAxOS41ODYwMDc1LDIuMzU0NDk3NzUgWiBNMTQuNTMwOTMyNSwwLjAwMDI4ODc4Mzg1NyBDMTUuMjY0MDg2MSwwLjAwMDI4ODc4Mzg1NyAxNS42MjY3OTcxLDAuMDM0ODM2NzQyOSAxNS44NTEyMDA3LDAuMjUwODMzMjY1IEMxNi4wNTc0Njg3LDAuNDQ5Njk5MzU4IDE2LjA0NTE1NTYsMC43NDk4MTY4MTEgMTUuODYzMTMyLDEuMDk5Njk4NjQgIEMxNS42OTcxNDM5LDEuNDE4NzY0ODMgMTUuNDE2OTAxOSwxLjkxMzYzMzI1IDE1LjMxMzYzMzI1IDE1LjQwMzYzNDQsMS45MzE2MjQ5OCBMMTU0MDM2MzQ0LDEuOTMxNjI0OTggTDcuNjg2NzAyNzksMi4wNTExNTUxOCBDNy43ODY3MDI3OSwyLjA1MTE1NTE4IDcuNzIxODkyMDUsMi4wMDUwMjc0MyA3LjY4ODEwMjY2LDEuOTgyMDU5MjYgQzYuNjY1NzM0ODEsMS4yODY2MDIxNCA0LjgzMjYxMjM3LDAuNjQwMDQ4MDg3IDQuMjY5NDU1NzgsMC40MzczNTM5NjUgQzQuMTgyMzA5NjgsMC40MTMxNDE2ODMgNC4xMDE2NTQyLDAuMzY5OTgwNjU5IDQuMDMzMTIwOTEsMC4zMTA5MzMzMTYgQzMuOTk0MjcyNjUsMC4yNjg4MjUgMy45Nzc0NzM0LDAuMjEwODMwMzY0IDMuOTg3ODc3NDgsMC4xNTQ0NjI2NDEgQzQuMDIxMjg1MDcsLTAuMDEzNzc5MjIyIDQuMjI4NTA3NjEsMC4wMDAyODg3ODU3IDQuMzEwMTE3NTksMC4wMDAyODg3ODM4NTcgWiBpZD0icGF0aC0zIj48L3BhdGg+PC9kZWZzPjxnIGlkPSItLS0t4pSXLS1HdWlkZXMiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGCI+PGcgaWQ9IipHdWlkZXMvVGVhc2Vycy9BY2UiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xMDEuMDAwMDAwLCAtNDkwLjAwMDAwMCkiPjxnIGlkPSJQbi9Qb3N0LU9mZmljZV9kZWZhdWx0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMDAuMDAwMDAwLCA0OTAuMDAwMDAwKSI+PGcgaWQ9Ikljb25zL1Bpbi1tYXBfMzdfWWVsbG93X0RlZmF1bHQtIj48bWFzayBpZD0ibWFzay0yIiBmaWxsPSJ3aGl0ZSI+PHVzZSB4bGluazpremVmPSIjcGF0aC0xIj48L3VzZT48L21hc2s+PHVzZSBpZD0iUGF0aC0iIGZpbGw9IiNGRkM5MjgiIGZpbGwtcnVsZT0ibm9uemVybyIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+PC9nPjxnIGlkPSJJY29ucy9Qb3N0LU9mZmljZV8yMC0iIHRyYW5zZm9ybT0idHJhbnNsYXRlKDcuMDAwMDAwLCAxNS4wMDAwMDApIj48bWFzayBpZD0ibWFzay00IiBmaWxsPSJ3aGl0ZSI+PHVzZSB4bGluazpremVmPSIjBGF0aC0zIj48L3VzZT48L21hc2s+PHVzZSBpZD0iaWNfYnVyZWF1LXBvc3RlIiBmaWxsPSIjM0MzNDM0IiB4bGluazpremVmPSIjcGF0aC0zIj48L3VzZT48ZyBpZD0iQ29sb3IiIG1hc2s9InVybCgjbWFzay00KSIgZmlsbD0iIzM5MzkzOSI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEyLjAwMDAwMCwgLTE3LjI3ODU1NSkiIGlkPSJSZWN0YW5nbGUiPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSI1MyIgaGVpZ2h0PSI1MyI+PC9yZWN0PjwvZz48L2c+PC9nPjwvZz48L2c+PC9nPjwvZz48L3N2Zz4=',
            iconSize: [35, 44],
            iconAnchor: [17, 44],
            popupAnchor: [0, -40]
        });

        let relayMarkers = {};

        async function searchRelays() {
            const zipInput = document.getElementById('mapZipInput');
            const zip = zipInput.value;
            const msgDiv = document.getElementById('mapSearchMsg');
            const listDiv = document.getElementById('relayList');

            if (!zip || zip.length < 5) {
                msgDiv.innerHTML = "<span class='validation-error-msg'>Code postal invalide.</span>";
                zipInput.classList.add('input-invalid');
                return;
            }

            msgDiv.innerHTML = "<span style='color: #0099ff; font-size:0.85rem;'>Recherche...</span>";
            listDiv.innerHTML = "<div style='text-align:center; padding-top:20px;'><div class='spinner' style='width:30px; height:30px; margin:0 auto;'></div></div>";
            zipInput.classList.remove('input-invalid');

            try {
                const resp = await fetch(`https://transporteur.up.railway.app/relay/search?zip=${zip}&type=colissimo`);

                if (resp.status === 404) {
                    msgDiv.innerHTML = "<span class='validation-error-msg'>Service non déployé (404).</span>";
                    listDiv.innerHTML = "<div style='padding:15px; color:#ff4444;'>L'API n'est pas encore prête sur le serveur. Veuillez patienter ou entrer l'ID manuellement.</div>";
                    return;
                }

                const data = await resp.json();
                markersLayer.clearLayers();
                listDiv.innerHTML = "";
                relayMarkers = {};

                if (data.status === 'success' && data.relays && data.relays.length > 0) {
                    msgDiv.innerHTML = `<span style='color: #28a745; font-size:0.85rem;'>✅ ${data.relays.length} points trouvés.</span>`;
                    const bounds = L.latLngBounds();

                    data.relays.forEach(relay => {

                        // Appliquer l'icône selon le type
                        let activeIcon = orangeIcon;
                        if (relay.type === 'BPR') activeIcon = yellowIcon;

                        const marker = L.marker([relay.lat, relay.lng], { icon: activeIcon });
                        const popupContent = `
                            <div class="relay-popup">
                                <b>${relay.name}</b><br>
                                ${relay.address}<br>
                                ${relay.zip} ${relay.city}<br>
                                <button type="button" class="relay-select-btn" onclick="selectRelay('${relay.id}', '${relay.type}')">Sélectionner ce point</button>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                        markersLayer.addLayer(marker);
                        relayMarkers[relay.id] = marker;

                        if (relay.lat && relay.lng) bounds.extend([relay.lat, relay.lng]);

                        const card = document.createElement("div");
                        card.className = "relay-card";
                        card.id = `card-${relay.id}`;
                        const distText = relay.distance > 0 ? `<span class="relay-distance">${relay.distance.toFixed(1)} km</span>` : '';

                        card.innerHTML = `
                            <div class="relay-card-title">
                                <span>${relay.name}</span>
                                ${distText}
                            </div>
                            <div class="relay-card-address">${relay.address}<br>${relay.zip} ${relay.city}</div>
                            <button type="button" class="relay-card-select-btn" onclick="event.stopPropagation(); selectRelay('${relay.id}', '${relay.type}')">Choisir ce point</button>
                        `;

                        card.onclick = () => {
                            marker.openPopup();
                            map.setView([relay.lat, relay.lng], 15);
                            document.querySelectorAll('.relay-card').forEach(c => c.classList.remove('active'));
                            card.classList.add('active');
                        };

                        listDiv.appendChild(card);
                    });

                    map.fitBounds(bounds, { padding: [20, 20] });
                } else {
                    msgDiv.innerHTML = "<span class='validation-error-msg'>Aucun résultat.</span>";
                    listDiv.innerHTML = "<div style='text-align:center; padding-top:20px; color:#8b949e;'>Aucun point relais trouvé ici.</div>";
                }
            } catch (e) {
                console.error("Map search error", e);
                msgDiv.innerHTML = "<span class='validation-error-msg'>Erreur réseau.</span>";
                listDiv.innerHTML = "<div style='padding:15px; color:#ff4444;'>Erreur lors de la récupération des données.</div>";
            }
        }

        window.selectRelay = function (id, type) {
            document.getElementById('pickupLocationId').value = id;
            if (type) {
                document.getElementById('pickupLocationType').value = type;
            }

            const input = document.getElementById('pickupLocationId');
            input.style.backgroundColor = 'rgba(40, 167, 69, 0.2)';
            setTimeout(() => input.style.backgroundColor = '', 1000);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const shippingDateInput = document.getElementById('shippingDate');
            if (shippingDateInput) shippingDateInput.value = today;

            setupVisibilityToggle('senderType', 'senderCompanyDiv');
            setupVisibilityToggle('receiverType', 'receiverCompanyDiv');

            fillDefaultSender();
            initMap();

            document.getElementById('btnSearchRelay').addEventListener('click', searchRelays);
            document.getElementById('mapZipInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchRelays();
                }
            });
        });
    </script>
</body>

</html>