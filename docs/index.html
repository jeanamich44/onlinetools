<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Zip Liste</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <h1>Zip Liste</h1>
    <p class="subtitle">
        Transforme une liste de textes en QR codes compressés dans un fichier ZIP.
    </p>

    <textarea placeholder="1 ligne = 1 QR code"></textarea>
    <div id="counter">0 / 4000 lignes</div>

    <button>Générer le ZIP</button>

    <p class="hint">Maximum 4000 lignes</p>
</div>

<script>
const textarea = document.querySelector("textarea");
const button = document.querySelector("button");
const counter = document.getElementById("counter");

const MAX_LINES = 4000;
const API_URL = "https://onlinetools-production.up.railway.app/generate-zip";

textarea.addEventListener("input", () => {
    const lines = textarea.value
        .split("\n")
        .map(l => l.trim())
        .filter(l => l !== "");

    counter.textContent = `${lines.length} / ${MAX_LINES} lignes`;
    counter.style.color = lines.length > MAX_LINES ? "#ef4444" : "#9ca3af";
});

button.addEventListener("click", async () => {
    const lines = textarea.value
        .split("\n")
        .map(l => l.trim())
        .filter(l => l !== "");

    if (lines.length === 0) {
        alert("La liste est vide");
        return;
    }

    if (lines.length > MAX_LINES) {
        alert("Maximum 4000 lignes");
        return;
    }

    button.disabled = true;
    button.textContent = "Génération en cours...";

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lines })
        });

        if (!response.ok) {
            let msg = "Erreur serveur";
            try {
                const err = await response.json();
                if (err.detail) msg = err.detail;
            } catch {}
            throw new Error(msg);
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "qr_codes.zip";
        a.click();

        URL.revokeObjectURL(url);

    } catch (err) {
        alert(err.message);
    } finally {
        button.disabled = false;
        button.textContent = "Générer le ZIP";
    }
});
</script>

</body>
</html>
