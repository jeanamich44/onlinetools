<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>RIB â€“ CrÃ©dit Mutuel</title>
  <link rel="stylesheet" href="../css/style.css">
</head>

<body>

  <!-- HEADER -->
  <header class="top-bar">
    <div class="top-bar-inner">
      <span class="logo" id="logo">OnlineTools</span>
      <button id="cartBtn">ðŸ›’ Panier</button>
    </div>
  </header>

  <div class="container">
    <h1>RIB CrÃ©dit Mutuel</h1>
    <p class="subtitle">GÃ©nÃ©ration PDF â€“ CrÃ©dit Mutuel</p>

    <form id="cmForm">
      <input name="nom_prenom" placeholder="Nom PrÃ©nom">
      <input name="adresse" placeholder="Adresse">
      <input name="cp_ville" placeholder="CP Ville">

      <input name="banque" placeholder="Code banque">
      <input name="guichet" placeholder="Code guichet">
      <input name="compte" placeholder="NumÃ©ro de compte">
      <input name="cle" placeholder="ClÃ© RIB">

      <input name="iban" placeholder="IBAN">

      <input name="agence" placeholder="Agence (ligne principale)">
      <input name="agence2" placeholder="Agence (bas de page)">
      <input name="agence_adresse" placeholder="Adresse agence">
      <input name="agence_cp_ville" placeholder="CP Ville agence">
      <input name="telephone" placeholder="TÃ©lÃ©phone">

      <button type="submit">GÃ©nÃ©rer PDF</button>
      <button type="button" id="addCart">Ajouter au panier â€“ 5 â‚¬</button>
    </form>

    <div id="message"></div>
    <a class="back" href="./rib-generator.html">Retour</a>
  </div>

  <script>
    /* ===== HEADER FIX ===== */
    const bar = document.querySelector(".top-bar");
    const inner = document.querySelector(".top-bar-inner");
    const cartBtn = document.getElementById("cartBtn");

    bar.style.position = "fixed";
    bar.style.top = "0";
    bar.style.left = "0";
    bar.style.width = "100%";
    bar.style.zIndex = "1000";

    inner.style.display = "flex";
    inner.style.alignItems = "center";
    inner.style.justifyContent = "space-between";
    inner.style.padding = "12px 24px";
    logo.onclick = () => window.location.href = "../index.html";

    /* STYLE BOUTON PANIER */
    cartBtn.style.all = "unset";
    cartBtn.style.display = "inline-flex";
    cartBtn.style.alignItems = "center";
    cartBtn.style.gap = "8px";
    cartBtn.style.background = "#2563eb";
    cartBtn.style.color = "#fff";
    cartBtn.style.padding = "8px 14px";
    cartBtn.style.borderRadius = "8px";
    cartBtn.style.cursor = "pointer";
    cartBtn.style.fontSize = "14px";
    cartBtn.style.fontWeight = "500";
    cartBtn.style.whiteSpace = "nowrap";
    cartBtn.style.marginLeft = "auto";

    cartBtn.onclick = () => {
      window.location.href = "../cart/cart.html";
    };

    /* ===== API PDF ===== */
    const API_URL = "https://generate-docs-production.up.railway.app/generate-pdf";
    const form = document.getElementById("cmForm");
    const message = document.getElementById("message");

    form.onsubmit = async (e) => {
      e.preventDefault();
      message.textContent = "GÃ©nÃ©ration en coursâ€¦";
      message.className = "";

      const data = Object.fromEntries(new FormData(form));
      data.type_pdf = "cm";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Erreur serveur");
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "rib_credit_mutuel.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();

        message.textContent = "PDF gÃ©nÃ©rÃ©";
        message.className = "success";

      } catch (err) {
        message.textContent = err.message;
        message.className = "error";
      }
    };

    /* ===== AJOUT AU PANIER (AVEC DONNÃ‰ES FORMULAIRE) ===== */
    document.getElementById("addCart").onclick = () => {
      const formData = Object.fromEntries(new FormData(form));

      const cartItem = {
        id: crypto.randomUUID(),
        type_pdf: "cm",
        name: "RIB CrÃ©dit Mutuel",
        price: 5,
        payload: formData,
        createdAt: new Date().toISOString(),
      };

      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      cart.push(cartItem);
      localStorage.setItem("cart", JSON.stringify(cart));

      const notif = document.createElement("div");
      notif.textContent = "AjoutÃ© au panier âœ“";
      notif.style.position = "fixed";
      notif.style.top = "70px";
      notif.style.right = "24px";
      notif.style.background = "#16a34a";
      notif.style.color = "#fff";
      notif.style.padding = "10px 16px";
      notif.style.borderRadius = "8px";
      notif.style.zIndex = "2000";
      document.body.appendChild(notif);

      setTimeout(() => notif.remove(), 2000);
    };
  </script>

</body>

</html>