<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>RIB – La Banque Postale</title>
  <link rel="stylesheet" href="../css/style.css">
</head>

<body>

  <!-- HEADER -->
  <header class="top-bar">
    <div class="top-bar-inner">
      <span class="logo" id="logo">OnlineTools</span>

    </div>
  </header>

  <div class="container">
    <h1>RIB LBP</h1>
    <p class="subtitle">Génération PDF – La Banque Postale</p>

    <form id="ribForm">
      <input name="sexe" placeholder="M / F">
      <input name="banque" placeholder="Banque">
      <input name="guichet" placeholder="Guichet">
      <input name="compte" placeholder="Compte">
      <input name="cle" placeholder="Clé">
      <input name="iban" placeholder="IBAN">
      <input name="bic" placeholder="BIC">
      <input name="nom_prenom" placeholder="Nom Prénom">
      <input name="adresse" placeholder="Adresse">
      <input name="cp_ville" placeholder="CP Ville">
      <input name="domiciliation" placeholder="Domiciliation">

      <button type="submit">Générer PDF</button>

    </form>

    <div id="message"></div>
    <div style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px;">
      <button id="btnPay" type="button" style="background-color: #007bff; width: 100%;">Payer 1€ (SumUp)</button>
    </div>
    <a class="back" href="./rib-generator.html">Retour</a>
  </div>

  <script>
    /* ===== HEADER FIX ===== */
    const bar = document.querySelector(".top-bar");
    const inner = document.querySelector(".top-bar-inner");


    bar.style.position = "fixed";
    bar.style.top = "0";
    bar.style.left = "0";
    bar.style.width = "100%";
    bar.style.zIndex = "1000";

    inner.style.display = "flex";
    inner.style.alignItems = "center";
    inner.style.justifyContent = "space-between";
    inner.style.padding = "12px 24px";
    logo.onclick = () => window.location.href = "../index.html";



    /* ===== PAIEMENT SUMUP ===== */
    const btnPay = document.getElementById("btnPay");
    btnPay.onclick = async () => {
      message.textContent = "Création du lien de paiement...";
      message.className = "";

      try {
        // Au besoin, changez l'URL si l'API est ailleurs
        // const API_BASE = "http://127.0.0.1:8000"; 
        const API_BASE = "https://generate-docs-production.up.railway.app";

        const res = await fetch(`${API_BASE}/create-payment`, { method: "POST" });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Erreur lors de la création du paiement");
        }

        const data = await res.json();
        if (data.payment_url) {
          window.location.href = data.payment_url;
        } else {
          throw new Error("Pas d'URL de paiement reçue");
        }
      } catch (err) {
        message.textContent = "Erreur Paiement: " + err.message;
        message.className = "error";
      }
    };

    /* ===== API PDF ===== */
    const API_URL = "https://generate-docs-production.up.railway.app/generate-pdf";
    const form = document.getElementById("ribForm");
    const message = document.getElementById("message");

    form.onsubmit = async (e) => {
      e.preventDefault();

      message.textContent = "Génération en cours...";
      message.className = "";

      const formData = Object.fromEntries(new FormData(form).entries());

      const payload = {
        type_pdf: "lbp",
        ...formData
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Erreur serveur");
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "rib_lbp.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();

        message.textContent = "PDF généré avec succès";
        message.className = "success";

      } catch (err) {
        message.textContent = err.message;
        message.className = "error";
      }
    };


  </script>

</body>

</html>