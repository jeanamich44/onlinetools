<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>RIB – BforBank</title>
  <link rel="stylesheet" href="../css/style.css">
</head>

<body>

  <div id="overlay" style="display: flex; flex-direction: column; gap: 20px;">
    <div class="spinner"></div>
    <div id="timerContainer" style="display:none; text-align: center; color: #fff;">
      <span style="font-size: 1.2rem; font-weight: bold;" id="timer">00:00</span>
      <span class="info-icon" style="margin-left: 10px; vertical-align: middle;"
        data-tooltip="La génération peut prendre quelques instants, veuillez rester sur la page.">i</span>
    </div>
  </div>


  <header class="top-bar">
    <div class="top-bar-inner">
      <span class="logo" id="logo">OnlineTools</span>

    </div>
  </header>

  <div class="container">
    <h1>RIB BforBank</h1>
    <p class="subtitle">Génération PDF – BforBank</p>

    <form id="bfbForm">
      <!-- Informations Personnelles -->
      <input name="nom_prenom" placeholder="Nom Prénom">
      <div id="error-nom"
        style="color: #dc3545; font-size: 0.85rem; margin-top: -12px; margin-bottom: 12px; display: none; text-align: left; font-weight: bold;">
        ⚠️ Le nom et prénom sont obligatoires pour le PDF final.</div>

      <input name="adresse" placeholder="Adresse">
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input name="cp" placeholder="Code Postal" style="flex: 1; margin-bottom: 0;">
        <input name="ville" placeholder="Ville" style="flex: 2; margin-bottom: 0;">
      </div>

      <!-- Informations Bancaires -->
      <input name="iban" placeholder="IBAN (FR)">
      <input name="banque" placeholder="Code banque (si IBAN non FR)">
      <input name="guichet" placeholder="Code guichet">
      <input name="compte" placeholder="Compte">
      <input name="cle" placeholder="Clé">

      <button type="submit">Générer Preview (Gratuit)</button>
    </form>

    <script src="../js/chronopost-autocomplete.js"></script>

    <div id="message"></div>
    <div style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px;">
      <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Le PDF final sans filigrane est payant (1€).</p>
      <button id="btnPay" type="button"
        style="background-color: #28a745; width: 100%; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">Acheter
        le PDF Final (1€)</button>
    </div>
    <a class="back" href="./rib-generator.html">Retour</a>
  </div>

  <script>


    const bar = document.querySelector(".top-bar");
    const inner = document.querySelector(".top-bar-inner");
    bar.style.position = "fixed";
    bar.style.top = "0";
    bar.style.left = "0";
    bar.style.width = "100%";
    bar.style.zIndex = "1000";
    inner.style.display = "flex";
    inner.style.alignItems = "center";
    inner.style.justifyContent = "space-between";
    inner.style.padding = "12px 24px";

    const logo = document.getElementById("logo");
    logo.onclick = () => window.location.href = "../index.html";

    const API_BASE = "https://generate-docs-production.up.railway.app";
    const ribForm = document.getElementById("bfbForm");
    const message = document.getElementById("message");
    const btnPay = document.getElementById("btnPay");
    const errorNom = document.getElementById("error-nom");
    const inputNom = document.getElementsByName("nom_prenom")[0];


    btnPay.onclick = async () => {
      const formData = Object.fromEntries(new FormData(ribForm).entries());

      if (!formData.nom_prenom) {
        errorNom.style.display = "block";
        inputNom.style.borderColor = "#dc3545";
        inputNom.focus();
        return;
      }

      errorNom.style.display = "none";
      inputNom.style.borderColor = "";

      const overlay = document.getElementById("overlay");
      overlay.style.visibility = "visible";
      const timerSpan = document.getElementById("timer");
      const timerContainer = document.getElementById("timerContainer");

      timerContainer.style.display = "block";
      let seconds = 0;
      timerSpan.textContent = "00:00";
      let timerInterval = setInterval(() => {
        seconds++;
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        timerSpan.textContent = `${m}:${s}`;
      }, 1000);

      await new Promise(resolve => setTimeout(resolve, 100));

      try {
        const payload = {
          type_pdf: "ca",
          ...formData
        };

        const res = await fetch(`${API_BASE}/create-payment?product_name=rib-ca`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Erreur création paiement");
        }

        const data = await res.json();
        const ref = data.checkout_ref;

        if (data.payment_url) {
          window.open(data.payment_url, "_blank");
          message.textContent = "Paiement en cours... Le téléchargement débutera automatiquement.";
          message.style.color = "#3498db";

          // Lancement du Long Polling résilient
          while (true) {
            try {
              const waitRes = await fetch(`${API_BASE}/api/wait-for-success/${ref}`);
              const waitData = await waitRes.json();

              if (waitData.status === "SUCCESS") {
                message.textContent = "✅ Paiement validé ! Téléchargement en cours...";
                message.style.color = "#28a745";

                if (overlay) overlay.style.visibility = "hidden";

                window.location.href = `${API_BASE}/api/download-pdf/${ref}`;
                break;
              } else if (waitData.status === "TIMEOUT") {
                continue; // Relance après le timeout du serveur/proxy
              } else {
                throw new Error("Le paiement a échoué ou a été annulé.");
              }
            } catch (pollErr) {
              console.error("Polling error:", pollErr);
              await new Promise(r => setTimeout(r, 2000));
              continue; // On insiste
            }
          }
        } else {
          throw new Error("Pas d'URL de paiement reçue");
        }
      } catch (err) {
        message.textContent = "Erreur: " + err.message;
        message.className = "error";
      } finally {
        overlay.style.visibility = "hidden";
        if (timerInterval) clearInterval(timerInterval);
        if (timerContainer) timerContainer.style.display = "none";
      }
    };


    ribForm.onsubmit = async (e) => {
      e.preventDefault();

      const overlay = document.getElementById("overlay");
      overlay.style.visibility = "visible";
      const timerSpan = document.getElementById("timer");
      const timerContainer = document.getElementById("timerContainer");

      timerContainer.style.display = "block";
      let seconds = 0;
      timerSpan.textContent = "00:00";
      let timerInterval = setInterval(() => {
        seconds++;
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        timerSpan.textContent = `${m}:${s}`;
      }, 1000);

      await new Promise(resolve => setTimeout(resolve, 100));

      message.textContent = "";
      message.className = "";

      const formData = Object.fromEntries(new FormData(ribForm).entries());

      const payload = {
        type_pdf: "bfb",
        preview: true,
        ...formData
      };

      try {
        const res = await fetch(`${API_BASE}/generate-pdf`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Erreur serveur");
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        // Détection de l'extension selon le type MIME
        const extension = blob.type.includes("image") ? "jpg" : "pdf";
        a.download = `preview_bfb.${extension}`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        message.textContent = "Preview générée ! Vérifiez vos infos avant de payer.";
        message.className = "success";

      } catch (err) {
        message.textContent = err.message;
        message.className = "error";
      } finally {
        overlay.style.visibility = "hidden";
        if (timerInterval) clearInterval(timerInterval);
        if (timerContainer) timerContainer.style.display = "none";
      }
    };



  </script>

</body>

</html>